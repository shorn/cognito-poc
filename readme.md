This repo is for learning about Cognito and aws-cdk.

# Running you own infrastructure

## Pre-requisites

* AWS account ID/alias
* Node/NPM available on the path

# Setting up AWS

## Manual creation of AWS resources for aws-cdk to use

### Create an IAM user for the CDK to use

Never use the "root account" of an AWS account to do stuff, this should be
the only time you need to log in to the root account.

If the account is an "organisation account" (being created under and
billed under some other account):
* go to https://aws.amazon.com/console/, click "sign in" at the top right
* make sure "root account" is selected and enter the email you were given for
  the account
* click "forgot password" to set the initial password for the root account
    * make it a good password, save it somewhere safe - I use Keepass


* Log in to your AWS root account.
* Go to IAM console and create user `aws-cdk-user`.
    * enable `password`
        * store your password somewhere safe
    * don't enable `access key` - do it in IAM after logging in as the user
    * attach user directly to `AdministratorAccess`
        * this is role is very powerful, ideally you should use a more 
        restricted role
* Write down your account number (will need it to log in to the IAM user)
* Immediately log out of your root account
* Log in to the `aws-cdk-user` IAM account you created previously
* Find the use in the IAM console and create an "Access key"
  * you will store these credentials in the `~/.aws` directory as outlined in 
  the next section 


## Credentials 

The aws-infra project manages all AWS resources via the `aws-cdk`.
It specifies the `cognito-poc` profile in all its scripts,
so setup your credentials/config using standard AWS profile mechanism.

`~/.aws/credentials`:
```
[cognito-poc]
# account: 9999, user: aws-cdk-user
aws_access_key_id=AKIAxxx
aws_secret_access_key=xxx
```

`~/.aws/config`:
```
[profile cognito-poc]
region=us-east-1
```

The access key defines the account that the CDK will use to create
resources, the region comes from the `config` file.

## Do bootstrap AWS deployment
* `cd <repo>/aws-infra`
* `npm run bootstrap`
  * this will create an S3bucket and other resources that aws-cdk uses to manage
  deployments
* `npm run deploy`
  * this will deploy all CDK stacks, note that the CloudFrontStack will deploy 
  any files from dir `<repo>/client/build` that were generated by the 
  client build, but there won't be anthing in there yet

## Configuration 
* configure Google dev console credentials and Google cognito user pool as 
needed
* populate [client Config.ts](./client/src/Config.ts) with the details for
the cognito user-pools
  * the current values in the source are for my test infrastructure, you need
  to change them over to point to your own infrastructure

## Build and deploy the client app
* `cd <repo>/client`
* `npm run build-prd`
  * this will build the client web app suitable for deploying to CloudFront
* `cd <repo>/aws-infra`
* `npm run deploy-cloudfront`
  * this will pick up the generated files from `<repo>/client/build`, upload
  them to the S3 bucket and clear the CloudFront cache

That's it - you should now be able to navigate to the URL for the app and 
sign in (look in the CloudFront console under "Distribution domain name").


